version: '3.8'

services:
  # Development workspace container
  demo-workspace:
    image: mcr.microsoft.com/devcontainers/typescript-node:1-22-bookworm
    volumes:
      - ../..:/workspaces/semiont:cached
    command: sleep infinity
    network_mode: service:backend
    environment:
      SEMIONT_VERSION: ${SEMIONT_VERSION:-0.2.0}
      SEMIONT_API_URL: http://localhost:4000
      NODE_ENV: production

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: semiont_demo
      POSTGRES_USER: semiont
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-semiont}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U semiont -d semiont_demo"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Semiont Backend API
  backend:
    image: ghcr.io/the-ai-alliance/semiont-backend:${SEMIONT_VERSION:-0.2.0}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../project:/workspace/project:cached
      - backend_data:/workspace/data
    environment:
      # Semiont configuration
      SEMIONT_ROOT: /workspace/project
      SEMIONT_ENV: demo
      # Database
      DATABASE_URL: postgresql://semiont:${POSTGRES_PASSWORD:-semiont}@postgres:5432/semiont_demo
      # JWT
      JWT_SECRET: ${JWT_SECRET:-demo-jwt-secret-minimum-32-characters-long}
      # Server
      PORT: 4000
      NODE_ENV: production
      # Auth
      ENABLE_LOCAL_AUTH: "true"
      # Optional AI services
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      NEO4J_URI: ${NEO4J_URI:-}
      NEO4J_USERNAME: ${NEO4J_USERNAME:-}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-}
      NEO4J_DATABASE: ${NEO4J_DATABASE:-}
    ports:
      - "4000:4000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Semiont Frontend UI
  frontend:
    image: ghcr.io/the-ai-alliance/semiont-frontend:${SEMIONT_VERSION:-0.2.0}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    env_file:
      - .env
    environment:
      # NextAuth secret (not in .env for security)
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-demo-nextauth-secret-minimum-32-characters-long}
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  postgres_data:
  backend_data:
